<!DOCTYPE busconfig PUBLIC "-//freedesktop//DTD D-BUS Bus Configuration 1.0//EN"
 "http://www.freedesktop.org/standards/dbus/1.0/busconfig.dtd">
<busconfig>
  <!-- This configuration file specifies the security policies for the
       ollama-proxy device manager D-Bus service. -->

  <!-- Only root can own the service -->
  <policy user="root">
    <allow own="ie.fio.OllamaProxy.DeviceManager"/>
    <allow send_destination="ie.fio.OllamaProxy.DeviceManager"/>
    <allow receive_sender="ie.fio.OllamaProxy.DeviceManager"/>
  </policy>

  <!-- Default policy for all users -->
  <policy context="default">
    <!-- Allow all users to receive signals from the device manager -->
    <allow receive_sender="ie.fio.OllamaProxy.DeviceManager"
           receive_interface="ie.fio.OllamaProxy.DeviceManager"
           receive_type="signal"/>

    <!-- Allow reading properties -->
    <allow send_destination="ie.fio.OllamaProxy.DeviceManager"
           send_interface="org.freedesktop.DBus.Properties"
           send_member="Get"/>
    <allow send_destination="ie.fio.OllamaProxy.DeviceManager"
           send_interface="org.freedesktop.DBus.Properties"
           send_member="GetAll"/>

    <!-- Allow introspection -->
    <allow send_destination="ie.fio.OllamaProxy.DeviceManager"
           send_interface="org.freedesktop.DBus.Introspectable"
           send_member="Introspect"/>

    <!-- Read-only operations: anyone can list and query devices -->
    <allow send_destination="ie.fio.OllamaProxy.DeviceManager"
           send_interface="ie.fio.OllamaProxy.DeviceManager"
           send_member="ListDevices"/>
    <allow send_destination="ie.fio.OllamaProxy.DeviceManager"
           send_interface="ie.fio.OllamaProxy.DeviceManager"
           send_member="GetDevice"/>

    <!-- Privileged operations: require Polkit authorization -->
    <!-- Note: These are denied by default, Polkit will handle authorization -->
    <deny send_destination="ie.fio.OllamaProxy.DeviceManager"
          send_interface="ie.fio.OllamaProxy.DeviceManager"
          send_member="RegisterDevice"/>
    <deny send_destination="ie.fio.OllamaProxy.DeviceManager"
          send_interface="ie.fio.OllamaProxy.DeviceManager"
          send_member="UnregisterDevice"/>
    <deny send_destination="ie.fio.OllamaProxy.DeviceManager"
          send_interface="ie.fio.OllamaProxy.DeviceManager"
          send_member="RequestDeviceAccess"/>
    <deny send_destination="ie.fio.OllamaProxy.DeviceManager"
          send_interface="ie.fio.OllamaProxy.DeviceManager"
          send_member="ReleaseDeviceAccess"/>
  </policy>

  <!-- Allow active session users to request device access
       (camera, microphone for local user) -->
  <policy at_console="true">
    <allow send_destination="ie.fio.OllamaProxy.DeviceManager"
           send_interface="ie.fio.OllamaProxy.DeviceManager"
           send_member="RequestDeviceAccess"/>
    <allow send_destination="ie.fio.OllamaProxy.DeviceManager"
           send_interface="ie.fio.OllamaProxy.DeviceManager"
           send_member="ReleaseDeviceAccess"/>
  </policy>

  <!-- Allow members of 'video' group to access camera devices -->
  <policy group="video">
    <allow send_destination="ie.fio.OllamaProxy.DeviceManager"
           send_interface="ie.fio.OllamaProxy.DeviceManager"
           send_member="RequestDeviceAccess"/>
  </policy>

  <!-- Allow members of 'audio' group to access audio devices -->
  <policy group="audio">
    <allow send_destination="ie.fio.OllamaProxy.DeviceManager"
           send_interface="ie.fio.OllamaProxy.DeviceManager"
           send_member="RequestDeviceAccess"/>
  </policy>

  <!-- Allow members of 'wheel' or 'sudo' group to register/unregister devices -->
  <policy group="wheel">
    <allow send_destination="ie.fio.OllamaProxy.DeviceManager"
           send_interface="ie.fio.OllamaProxy.DeviceManager"
           send_member="RegisterDevice"/>
    <allow send_destination="ie.fio.OllamaProxy.DeviceManager"
           send_interface="ie.fio.OllamaProxy.DeviceManager"
           send_member="UnregisterDevice"/>
  </policy>

  <policy group="sudo">
    <allow send_destination="ie.fio.OllamaProxy.DeviceManager"
           send_interface="ie.fio.OllamaProxy.DeviceManager"
           send_member="RegisterDevice"/>
    <allow send_destination="ie.fio.OllamaProxy.DeviceManager"
           send_interface="ie.fio.OllamaProxy.DeviceManager"
           send_member="UnregisterDevice"/>
  </policy>
</busconfig>
